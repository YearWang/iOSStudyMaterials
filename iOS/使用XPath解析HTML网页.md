# 使用XPath解析HTML网页


---

##1.什么是XPath
Wikipedia这样解释XPath：XPath即为XML路径语言（XML Path Language），它是一种用来确定XML文档中某部分位置的语言。

这里讨论的是在XPath语言规范下，封装而成的一种解析XML文档的技术。在PHP，Python里，具体是指xpath这个函数。所以，Wikipedia提到的对XML文档某部分位置的定位，就是用XPath的规范，定位到这个部分，为我所用。

我们的目的是解析HTML网页中的元素，将HTML转换成XML文档之后，就是XPath出鞘之时。具体的转换方法，因开发环境而异，后文会附上一些实际工作中遇到的问题
。
下文所述的xpath()函数均指PHP语言核心函数库中的函数xpath()。
##2.XPath路径表达式
在使用XPath之前，需要先了解下XPath的节点，路径概念，这也是XPath这门语言的单词和语法。不求全通，至少了解嘛。其中，路径表达式是xpath()的传入参数。xpath()使用路径表达式对XML文档中的某个节点（或者多个节点）进行定位。

路径表达式实例：`/html/body/div[@class=”content”]` 。按照节点和路径概念，这个表达式是按照html，body，div层级关系，寻找属性里有`class=”content”`的div节点。当然，这个结果也可能是多个节点。
##3.深入路径表达式
先来推荐一个详细版的路径表达式教程文章xpath Manual。
有如下几种常见的组成结构：
###1.绝对路径方式
绝对路径方式是从根节点开始导航，逐级而进，像上文提到的实例一样，直到想要抓取的节点。这种方式会让xpath()有更高的效率，稍后解释这点。
###2.相对路径方式
这种方式不用考虑相对于根节点，要抓取的节点所在的所有级别路径。而是只需要知道当前节点上下几个级别的节点即可。在人工定位路径的时候，会更方便一些。如你所想，它的代码执行效率要比绝对路径低一些。
###3.属性结构
XML文档可能有多个相同标签在同一级别，例如下面这个例子：

    <?xml version=”1.0″ encoding=”ISO-8859-1″?>
    <div id=”all”>
    <div class=”figure-1”>
    <title lang=”eng”>Harry Potter</title>
    <p>29.99</p>
    </div>
    <div class=”figure-2”>
    <title lang=”eng”>Learning XML</title>
    <p>39.95</p>
    </div>
    </div>

想要选择

这个标签的内容，需要对div标签进行更详细的说明，才能区别于其他的同级别标签。属性结构在这时候发挥作用。’@’符号，为区分而生，像区分各家邮箱后缀一样。`//div[@class=”figure-1”]` (这里选择相对路径方式)。
##4.XPath实践
###1.效率问题
如果xpath()的路径表达式参数是从根元素开始的，是定位效率最高的。这点容易解释，就像在一层办公大楼格子间去寻找一位同事一样。相比指定楼层，逐个去问，给定一条直通这位同事的地图会更快。

但是有时候从根元素开始，人工地定位路径表达式的参数并不方便（可以借助插件解决），或者是出于自己封装的解析函数的泛型化的要求，选择相对路径，牺牲些代码效率仍然是明智之举（人力才是最贵资源）。

以下是我的一些思考测试。

如果相对路径往上级多写几层，路径变得更加具体，应该会提升效率，但是测试之后，时间反而增加了2-3倍。

初始例子是这样的 `‘//span[@id="media_span"]/span’。`
加了几层变成这样`‘//div/div/div/span[@id="media_span"]/span’。`

推测xpath的索引方式很可能像NTFS文件系统一样。经过统计当篇XML文档的元素个数，span 20个，而div是90个，得证。

所以，在使用相对路径的时候，div这种极易出现的标签元素尽量不要放在起始节点。

从根节点开始解析比以上span开始的例子相比，只快了一点（粗略测试多篇文档，10万次解析差2秒）。
###2.不能跨级
在选择路径表达式的时候，不能出现跨级别的元素，否则路径表达式是不能被xpath()解析的。

还拿上图举例，不可以用//div[@id=”all”]/title参数去解析div class=”figure-1”下面的title标签。这是一种跨级。
###3.可以使用’|’，简化解析
使用’|’操作符可以让xpath()在XML文档上多重匹配。在解析多条目网页时会大幅提升扩展性。

例如，//div [@id="syncad_1"]/h1|//div [@id="syncad_1"]/p 参数可以对新浪新闻页做多次结果匹配，对应’或’操作符的两个参数。

xpath()解析结果如下图：

![xpath][1]

###4.注意命名空间
当XML遇上命名空间无法解析的时候，加上对应的命名空间即可（上图也可参考）。更高级的操作方式可见手册。
###5.最方便的确定路径参数的方式
审查元素，右键copy xpath（Firefox和chrome都适用），可以直接给出从根开始的xpath路径。
##5.XPath开发工具推荐
1.firfox下的xpath checker，输入xpath路径之后，可视化解析结果，方便判断路径的对错。需要注意的是当firefox加载新的网页之后要重新打开xpath checker，以便重新加载XML文档。

2.Chrome下的xpath finder也有类似功能。

3.Mac下的xpath explorer可以在网页中直接选取内容生成从根开始的xpath路径。


  [1]: http://upload-images.jianshu.io/upload_images/679447-115f07cfe1521a69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240